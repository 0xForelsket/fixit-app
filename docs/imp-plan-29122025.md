# FixIt CMMS - Implementation Plan (December 29, 2025)

> **Generated:** December 29, 2025  
> **Based on:** `docs/recommendations.md` codebase critique  
> **Target:** Production-ready deployment  
> **Estimated Effort:** ~2 weeks

---

## üìä Current State Assessment

| Category | Score | Status |
|----------|-------|--------|
| Core Functionality | 8/10 | ‚úÖ Ready |
| Code Quality | 7.5/10 | ‚ö†Ô∏è Minor TypeScript error |
| Security | 6/10 | üî¥ Needs hardening |
| Reliability | 5/10 | üî¥ In-memory rate limiting |
| Operations | 4/10 | üî¥ No monitoring |
| UI/UX | 8/10 | ‚úÖ Well-designed |

### Build Status
```bash
# Current build error:
src/app/(operator)/my-tickets/page.tsx(119,18): error TS2304: Cannot find name 'Timer'.
```

---

## Phase 1: Critical Fixes (Day 1)

### 1.1 Fix TypeScript Build Error

**Status:** üî¥ Blocking  
**File:** `src/app/(operator)/my-tickets/page.tsx:119`  
**Issue:** Missing `Timer` import from lucide-react

#### Task:
```typescript
// Add Timer to the imports at line 8
import {
  ArrowRight,
  Clock,
  History,
  Inbox,
  MonitorCog,
  Timer,  // ADD THIS
  User as UserIcon,
} from "lucide-react";
```

#### Verification:
```bash
bun run build:check
# Expected: No errors
```

---

### 1.2 Create Health Check Endpoint

**Status:** üî¥ Missing  
**Location:** `src/app/api/health/route.ts` (new file)  
**Why:** Referenced in middleware but doesn't exist; required for monitoring

#### Task: Create `/api/health` endpoint

```typescript
// src/app/api/health/route.ts
import { db } from "@/db";
import { sql } from "drizzle-orm";
import { NextResponse } from "next/server";

export const dynamic = "force-dynamic";

export async function GET() {
  const startTime = Date.now();
  
  try {
    // Check database connectivity
    await db.run(sql`SELECT 1`);
    const dbLatency = Date.now() - startTime;
    
    return NextResponse.json({
      status: "healthy",
      timestamp: new Date().toISOString(),
      version: process.env.npm_package_version || "0.1.0",
      checks: {
        database: {
          status: "healthy",
          latencyMs: dbLatency,
        },
      },
      uptime: process.uptime(),
    });
  } catch (error) {
    return NextResponse.json(
      {
        status: "unhealthy",
        timestamp: new Date().toISOString(),
        checks: {
          database: {
            status: "unhealthy",
            error: error instanceof Error ? error.message : "Unknown error",
          },
        },
      },
      { status: 503 }
    );
  }
}
```

#### Verification:
```bash
curl http://localhost:3000/api/health
# Expected: {"status":"healthy",...}
```

---

### 1.3 Wrap JSON.parse in Try/Catch

**Status:** üü† Risk  
**Files with unsafe JSON.parse:**
- `src/actions/workOrders.ts:43`
- `src/hooks/use-time-logger.ts:30`
- `src/app/api/import/spare-parts/route.ts:29`
- `src/app/api/import/users/route.ts:29`
- `src/app/api/import/locations/route.ts:29`
- `src/app/api/import/equipment/route.ts:35`

#### Task 1.3.1: Create safe JSON parse utility

```typescript
// Add to src/lib/utils.ts

/**
 * Safely parse JSON with error handling
 * @returns parsed value or undefined on failure
 */
export function safeJsonParse<T>(json: string | null | undefined): T | undefined {
  if (!json) return undefined;
  try {
    return JSON.parse(json) as T;
  } catch {
    return undefined;
  }
}

/**
 * Safely parse JSON with a default value
 */
export function safeJsonParseWithDefault<T>(json: string | null | undefined, defaultValue: T): T {
  if (!json) return defaultValue;
  try {
    return JSON.parse(json) as T;
  } catch {
    return defaultValue;
  }
}
```

#### Task 1.3.2: Update `src/actions/workOrders.ts`

```typescript
// Line 43 - Replace:
const parsedAttachments = attachmentsJson ? JSON.parse(attachmentsJson) : [];

// With:
const parsedAttachments = safeJsonParseWithDefault<string[]>(attachmentsJson, []);
```

#### Task 1.3.3: Update `src/hooks/use-time-logger.ts`

```typescript
// Line 30 - Wrap in try/catch or use safeJsonParse
const savedTimer = sessionStorage.getItem(STORAGE_KEY);
if (savedTimer) {
  const parsed = safeJsonParse<{ start: number }>(savedTimer);
  if (parsed?.start) {
    // ... existing logic
  }
}
```

---

## Phase 2: Security Hardening (Days 2-3)

### 2.1 Replace In-Memory Rate Limiting

**Status:** üî¥ Critical  
**Current:** `src/lib/rate-limit.ts` uses `Map` (fails on restart/scaling)  
**Solution:** Abstract rate limiting behind interface, optionally use Redis

#### Task 2.1.1: Create rate limit abstraction

```typescript
// src/lib/rate-limit.ts - Refactored version

export interface RateLimiter {
  check(key: string, limit: number, windowMs: number): Promise<RateLimitResult>;
}

// In-memory implementation (for development)
class InMemoryRateLimiter implements RateLimiter {
  private store = new Map<string, RateLimitEntry>();
  
  async check(key: string, limit: number, windowMs: number): Promise<RateLimitResult> {
    // ... existing logic, wrapped in Promise
  }
}

// Redis implementation (for production)
// Placeholder - implement with @upstash/ratelimit when Redis is available
class RedisRateLimiter implements RateLimiter {
  async check(key: string, limit: number, windowMs: number): Promise<RateLimitResult> {
    // TODO: Implement with Upstash or ioredis
    throw new Error("Redis rate limiter not configured");
  }
}

// Factory function
export function createRateLimiter(): RateLimiter {
  if (process.env.REDIS_URL) {
    // return new RedisRateLimiter();
  }
  return new InMemoryRateLimiter();
}

// Default instance
export const rateLimiter = createRateLimiter();
```

#### Task 2.1.2: Add environment variable

```bash
# .env.example - Add:
REDIS_URL=           # Optional: Redis URL for distributed rate limiting
```

---

### 2.2 Enforce Stronger PIN Requirements

**Status:** üü† Weak  
**Current:** 4-digit PINs (10,000 combinations)  
**Target:** 6-digit minimum (1,000,000 combinations)

#### Task 2.2.1: Update validation schema

```typescript
// src/lib/validations/auth.ts - Update PIN validation

export const pinSchema = z
  .string()
  .min(6, "PIN must be at least 6 digits")
  .max(8, "PIN must be at most 8 digits")
  .regex(/^\d+$/, "PIN must contain only numbers");
```

#### Task 2.2.2: Update UI to show new requirements

- Update login PIN input `maxLength` to 8
- Update user creation form PIN field
- Add migration notice for existing 4-digit PINs (optional)

---

### 2.3 Add Admin Audit Log

**Status:** üî¥ Missing  
**Why:** No record of who changed what (compliance risk)

#### Task 2.3.1: Add schema

```typescript
// Add to src/db/schema.ts

export const adminAuditLogActions = [
  "user_created",
  "user_updated",
  "user_deleted",
  "role_created",
  "role_updated",
  "role_deleted",
  "equipment_created",
  "equipment_deleted",
  "settings_changed",
] as const;
export type AdminAuditLogAction = (typeof adminAuditLogActions)[number];

export const adminAuditLogs = sqliteTable("admin_audit_logs", {
  id: integer("id").primaryKey({ autoIncrement: true }),
  actorId: integer("actor_id")
    .references(() => users.id)
    .notNull(),
  action: text("action", { enum: adminAuditLogActions }).notNull(),
  targetType: text("target_type").notNull(), // 'user', 'role', 'equipment'
  targetId: integer("target_id"),
  targetName: text("target_name"),
  previousValue: text("previous_value", { mode: "json" }),
  newValue: text("new_value", { mode: "json" }),
  ipAddress: text("ip_address"),
  userAgent: text("user_agent"),
  createdAt: integer("created_at", { mode: "timestamp" })
    .notNull()
    .default(sql`(unixepoch())`),
});
```

#### Task 2.3.2: Create audit logging utility

```typescript
// src/lib/audit.ts

import { db } from "@/db";
import { adminAuditLogs, type AdminAuditLogAction } from "@/db/schema";

interface AuditLogParams {
  actorId: number;
  action: AdminAuditLogAction;
  targetType: string;
  targetId?: number;
  targetName?: string;
  previousValue?: Record<string, unknown>;
  newValue?: Record<string, unknown>;
  ipAddress?: string;
  userAgent?: string;
}

export async function logAdminAction(params: AuditLogParams): Promise<void> {
  await db.insert(adminAuditLogs).values({
    ...params,
    previousValue: params.previousValue ? JSON.stringify(params.previousValue) : null,
    newValue: params.newValue ? JSON.stringify(params.newValue) : null,
  });
}
```

#### Task 2.3.3: Integrate into admin actions

Add `logAdminAction()` calls to:
- `src/actions/users.ts` - createUser, updateUser, deleteUser
- `src/actions/roles.ts` - createRole, updateRole, deleteRole
- `src/actions/equipment.ts` - createEquipment, deleteEquipment

---

### 2.4 Session Invalidation on PIN Change

**Status:** üü† Missing  
**Issue:** Old sessions remain valid after PIN reset

#### Task: Add session version to users table

```typescript
// Add to users table in schema.ts
sessionVersion: integer("session_version").notNull().default(0),

// In session.ts createSession(), include sessionVersion in JWT
// In getSession(), verify sessionVersion matches current user
```

---

## Phase 3: Operational Readiness (Days 4-5)

### 3.1 Enhance Pino Structured Logging

**Status:** üü† Partial  
**Current:** `src/lib/logger.ts` exists but underutilized  
**Why:** Need consistent error logging with request context for debugging

#### Task 3.1.1: Enhance logger configuration

```typescript
// src/lib/logger.ts - Enhanced version

import pino from "pino";

const isDev = process.env.NODE_ENV !== "production";

export const logger = pino({
  level: process.env.LOG_LEVEL || (isDev ? "debug" : "info"),
  formatters: {
    level: (label: string) => ({ level: label }),
    bindings: () => ({}), // Remove pid/hostname in prod logs
  },
  // Add timestamp in ISO format
  timestamp: pino.stdTimeFunctions.isoTime,
  // Redact sensitive fields
  redact: {
    paths: ["pin", "password", "token", "authorization", "cookie"],
    censor: "[REDACTED]",
  },
});

// Module-specific loggers
export const authLogger = logger.child({ module: "auth" });
export const dbLogger = logger.child({ module: "db" });
export const apiLogger = logger.child({ module: "api" });
export const inventoryLogger = logger.child({ module: "inventory" });
export const workOrderLogger = logger.child({ module: "workOrder" });

// Error logging helper with stack trace
export function logError(
  logger: pino.Logger,
  error: unknown,
  context?: Record<string, unknown>
): void {
  const err = error instanceof Error ? error : new Error(String(error));
  logger.error({
    err: {
      message: err.message,
      name: err.name,
      stack: err.stack,
    },
    ...context,
  });
}
```

#### Task 3.1.2: Create API error logging middleware

```typescript
// src/lib/api-error.ts

import { NextResponse } from "next/server";
import { apiLogger, generateRequestId } from "./logger";

interface ApiErrorOptions {
  status?: number;
  requestId?: string;
  logContext?: Record<string, unknown>;
}

export function apiError(
  message: string,
  error?: unknown,
  options: ApiErrorOptions = {}
): NextResponse {
  const { status = 500, requestId = generateRequestId(), logContext = {} } = options;
  
  // Log the error with context
  if (error) {
    const err = error instanceof Error ? error : new Error(String(error));
    apiLogger.error({
      requestId,
      message,
      err: { message: err.message, stack: err.stack },
      ...logContext,
    });
  }
  
  // Return sanitized response (no stack traces to client)
  return NextResponse.json(
    {
      error: message,
      requestId,
      timestamp: new Date().toISOString(),
    },
    { status }
  );
}

// Success response helper
export function apiSuccess<T>(data: T, status = 200): NextResponse {
  return NextResponse.json(data, { status });
}
```

#### Task 3.1.3: Update API routes to use structured logging

Example pattern for API routes:
```typescript
// In any API route handler
import { apiError, apiSuccess } from "@/lib/api-error";
import { apiLogger, generateRequestId } from "@/lib/logger";

export async function POST(request: Request) {
  const requestId = generateRequestId();
  
  try {
    // ... handler logic
    apiLogger.info({ requestId, action: "created_work_order" });
    return apiSuccess({ id: newId });
  } catch (error) {
    return apiError("Failed to create work order", error, { requestId });
  }
}
```

#### Task 3.1.4: Add log aggregation recommendation to docs

Document that production deployments should:
- Pipe logs to a file: `bun run start > /var/log/fixit/app.log 2>&1`
- Use log rotation: `logrotate` configuration
- Optional: Send to Axiom, Logtail, or Loki for searchable logs

---

### 3.2 Document Backup Procedure

**Status:** üî¥ Missing  
**Database:** SQLite at `./local.db`

#### Task: Add to README.md or create `docs/prod/BACKUP.md`

```markdown
# Backup Procedure

## SQLite Backup

### Manual Backup
\`\`\`bash
# Stop the application (or use SQLite online backup)
cp local.db backups/local.db.$(date +%Y%m%d_%H%M%S)
\`\`\`

### Automated Backup (cron)
\`\`\`bash
# Add to crontab -e
0 */6 * * * sqlite3 /path/to/local.db ".backup '/path/to/backups/local.db.bak'"
\`\`\`

### Restore
\`\`\`bash
# Stop the application
cp backups/local.db.YYYYMMDD_HHMMSS local.db
# Restart the application
\`\`\`

## Recommended Schedule
- **Daily:** Full backup at midnight
- **Retention:** Keep 7 daily, 4 weekly, 12 monthly
```

---

### 3.3 Add Environment Guard to Seed Script

**Status:** üü† Risk  
**File:** `src/db/seed.ts`

#### Task: Add production guard

```typescript
// Add at the very top of src/db/seed.ts

if (process.env.NODE_ENV === "production") {
  console.error("‚ùå FATAL: Cannot run seed in production environment!");
  console.error("   Set NODE_ENV to 'development' or 'test' to run this script.");
  process.exit(1);
}

// Also add confirmation prompt
const readline = await import("readline");
const rl = readline.createInterface({ input: process.stdin, output: process.stdout });

const answer = await new Promise<string>((resolve) => {
  rl.question("‚ö†Ô∏è  This will DELETE all data. Continue? (yes/no): ", resolve);
});
rl.close();

if (answer.toLowerCase() !== "yes") {
  console.log("Aborted.");
  process.exit(0);
}
```

---

## Phase 4: Database Improvements (Day 6)

### 4.1 Add Missing Indexes

**Status:** üü† Performance  
**File:** `src/db/schema.ts`

#### Task: Add composite indexes

```typescript
// Add to workOrders table definition

(table) => ({
  statusIdx: index("wo_status_idx").on(table.status),
  priorityIdx: index("wo_priority_idx").on(table.priority),
  dueByIdx: index("wo_due_by_idx").on(table.dueBy),
  assignedToIdx: index("wo_assigned_to_idx").on(table.assignedToId),
  // ADD THESE:
  assignedStatusIdx: index("wo_assigned_status_idx").on(table.assignedToId, table.status),
  equipmentCreatedIdx: index("wo_equipment_created_idx").on(table.equipmentId, table.createdAt),
})

// Add to notifications table
(table) => ({
  userIdIdx: index("notif_user_idx").on(table.userId),
  // ADD THIS:
  userReadIdx: index("notif_user_read_idx").on(table.userId, table.isRead),
})

// Add to laborLogs table (new)
(table) => ({
  workOrderUserIdx: index("labor_wo_user_idx").on(table.workOrderId, table.userId),
})
```

#### Verification:
```bash
bun run db:generate
bun run db:migrate
```

---

## Phase 5: UI/UX Improvements (Days 7-10)

### 5.1 Implement Dark Mode

**Status:** üü° Enhancement  
**Why:** Factory floor visibility in varying lighting

#### Task 5.1.1: Add CSS variables for dark mode

```css
/* globals.css - Add dark mode variables */
@media (prefers-color-scheme: dark) {
  :root {
    --background: 240 10% 4%;
    --foreground: 0 0% 98%;
    --card: 240 10% 6%;
    --card-foreground: 0 0% 98%;
    /* ... etc */
  }
}

/* Or use a class-based approach */
.dark {
  --background: 240 10% 4%;
  /* ... */
}
```

#### Task 5.1.2: Add theme toggle component

```typescript
// src/components/ui/theme-toggle.tsx
"use client";

import { Moon, Sun } from "lucide-react";
import { useEffect, useState } from "react";

export function ThemeToggle() {
  const [theme, setTheme] = useState<"light" | "dark">("light");
  
  useEffect(() => {
    const stored = localStorage.getItem("theme");
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    setTheme(stored as "light" | "dark" || (prefersDark ? "dark" : "light"));
  }, []);
  
  const toggle = () => {
    const next = theme === "light" ? "dark" : "light";
    setTheme(next);
    localStorage.setItem("theme", next);
    document.documentElement.classList.toggle("dark", next === "dark");
  };
  
  return (
    <button onClick={toggle} aria-label="Toggle theme">
      {theme === "light" ? <Moon /> : <Sun />}
    </button>
  );
}
```

---

### 5.2 Add Reduced Motion Support

**Status:** üü¢ Accessibility  
**File:** `src/app/globals.css`

#### Task: Add prefers-reduced-motion media query

```css
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}
```

---

### 5.3 Add Recent Equipment for Operators

**Status:** üü° UX Enhancement  
**Why:** Reduce friction for repeat reports

#### Task: Store last 5 reported equipment in localStorage

```typescript
// src/hooks/use-recent-equipment.ts
"use client";

const STORAGE_KEY = "fixit_recent_equipment";
const MAX_RECENT = 5;

interface RecentEquipment {
  id: number;
  code: string;
  name: string;
  timestamp: number;
}

export function useRecentEquipment() {
  const getRecent = (): RecentEquipment[] => {
    if (typeof window === "undefined") return [];
    const stored = localStorage.getItem(STORAGE_KEY);
    if (!stored) return [];
    try {
      return JSON.parse(stored);
    } catch {
      return [];
    }
  };
  
  const addRecent = (equipment: Omit<RecentEquipment, "timestamp">) => {
    const current = getRecent().filter((e) => e.id !== equipment.id);
    const updated = [{ ...equipment, timestamp: Date.now() }, ...current].slice(0, MAX_RECENT);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
  };
  
  return { getRecent, addRecent };
}
```

---

## Phase 6: Documentation & Testing (Days 11-12)

### 6.1 Update AGENTS.md

Add sections for:
- Rate limiting configuration
- Audit logging usage
- Health endpoint
- New hooks and utilities

### 6.2 Add Integration Tests for Critical Paths

**Priority paths:**
- Login flow
- Work order creation
- Work order status changes
- Equipment QR scan

#### Task: Create test files

```typescript
// e2e/work-order-flow.spec.ts
import { test, expect } from "@playwright/test";

test.describe("Work Order Flow", () => {
  test("operator can create work order", async ({ page }) => {
    // Login as operator
    // Navigate to equipment
    // Click "Report Issue"
    // Fill form
    // Submit
    // Verify success
  });
  
  test("technician can update work order status", async ({ page }) => {
    // Login as tech
    // Open work order
    // Change status
    // Verify log entry
  });
});
```

---

## Phase 7: Final Validation (Days 13-14)

### 7.1 Security Scan

```bash
# Run OWASP ZAP or similar
# Check for:
# - XSS vulnerabilities
# - CSRF protection
# - SQL injection
# - Authentication bypasses
```

### 7.2 Performance Validation

```bash
# Lighthouse audit
# Check:
# - First Contentful Paint < 1.5s
# - Time to Interactive < 3s
# - Performance score > 80
```

### 7.3 Disaster Recovery Test

1. Take backup of `local.db`
2. Delete database
3. Restore from backup
4. Verify all data intact

---

## Summary Checklist

### Phase 1: Critical Fixes (Day 1)
- [ ] **1.1** Fix Timer import in my-tickets page
- [ ] **1.2** Create `/api/health` endpoint
- [ ] **1.3** Add safe JSON parse utility and update usages

### Phase 2: Security Hardening (Days 2-3)
- [ ] **2.1** Abstract rate limiting for future Redis support
- [ ] **2.2** Enforce 6-digit PIN minimum
- [ ] **2.3** Add admin audit log table and utility
- [ ] **2.4** Add session version for PIN change invalidation

### Phase 3: Operational Readiness (Days 4-5)
- [ ] **3.1** Enhance Pino structured logging with error helpers
- [ ] **3.2** Document backup procedure
- [ ] **3.3** Add production guard to seed script

### Phase 4: Database Improvements (Day 6)
- [ ] **4.1** Add composite indexes for common queries

### Phase 5: UI/UX Improvements (Days 7-10)
- [ ] **5.1** Implement dark mode
- [ ] **5.2** Add reduced motion support
- [ ] **5.3** Add recent equipment for operators

### Phase 6: Documentation & Testing (Days 11-12)
- [ ] **6.1** Update AGENTS.md with new patterns
- [ ] **6.2** Add integration tests for critical paths

### Phase 7: Final Validation (Days 13-14)
- [ ] **7.1** Run security scan
- [ ] **7.2** Performance validation
- [ ] **7.3** Disaster recovery test

---

## Commands Reference

```bash
# Development
bun run dev              # Start dev server
bun run build:check      # TypeScript check
bun run lint             # Lint check
bun run lint:fix         # Auto-fix lint issues

# Database
bun run db:generate      # Generate migrations
bun run db:migrate       # Run migrations
bun run db:studio        # Open Drizzle Studio
bun run db:seed          # Seed database (dev only!)

# Testing
bun run test:run         # Unit tests
bun run e2e              # E2E tests
```

---

## Notes for Agents

- Always run `bun run build:check` after TypeScript changes
- Always run `bun run lint:fix` before committing
- Update this document as items are completed
- Mark completed items with ‚úÖ and date
- If blocked, document the blocker and move to next task
