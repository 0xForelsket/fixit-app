# Handover Document - 2026-01-05

## Context

Implementing Equipment Premium Features (Phases 1-4) from the equipment premium plan. The goal is to add specifications, financials, meters, and downtime tracking to equipment management.

## Completed Work

### 1. Schema Changes (Previous Session)
- Added 8 fields to `equipment` table: serialNumber, manufacturer, modelYear, warrantyExpiration, purchaseDate, purchasePrice, residualValue, usefulLifeYears
- Created 3 new tables: `equipmentMeters`, `meterReadings`, `downtimeLogs`
- File: `src/db/schema.ts`

### 2. Validation Schemas (Previous Session)
- Added `specificationsSchema`, `financialsSchema`, `meterSchema`, `meterReadingSchema`, `downtimeLogSchema`
- File: `src/lib/validations/equipment.ts`

### 3. Depreciation Utility (Previous Session)
- Created straight-line depreciation calculator
- File: `src/lib/utils/depreciation.ts`

### 4. Equipment Form Tabs (Previous Session)
- Refactored equipment form to use PillTabs with 6 tabs
- Created tab components: GeneralTab, OrganizationTab, SpecificationsTab, FinancialsTab, DocumentsTab, MetersTab
- Files: `src/app/(app)/assets/equipment/equipment-form.tsx`, `src/app/(app)/assets/equipment/tabs/`

### 5. Meter API Routes (Previous Session)
- CRUD for meters: `src/app/(app)/api/equipment/[id]/meters/route.ts`
- Individual meter ops: `src/app/(app)/api/equipment/meters/[meterId]/route.ts`

### 6. Permissions (This Session)
Added to `src/lib/permissions.ts`:
```typescript
EQUIPMENT_FINANCIALS_VIEW: "equipment:financials:view",
EQUIPMENT_METERS_RECORD: "equipment:meters:record",
EQUIPMENT_DOWNTIME_REPORT: "equipment:downtime:report",
```
Tech role has `meters:record` and `downtime:report` by default.

### 7. Edit Page Data Loading (This Session)
- Updated `src/app/(app)/assets/equipment/[code]/edit/page.tsx`
- Now loads meters and attachments with signed URLs
- Passes to EquipmentForm component

### 8. Detail Page Enhancements (This Session)
Updated `src/app/(app)/assets/equipment/[code]/page.tsx`:
- Added SpecificationsSection (visible to all)
- Added FinancialsSection (requires `equipment:financials:view`)
- Added MetersSection with "Record Reading" button
- Added DowntimeSection with "Report Downtime" button

## Remaining Tasks

### 1. Report Downtime Dialog (Priority: High)
**Status**: Button rendered but non-functional
**Location**: Detail page `src/app/(app)/assets/equipment/[code]/page.tsx`
**What's needed**:
- Create a dialog component for reporting downtime
- Form fields: reasonCode (dropdown), startTime, endTime (optional for ongoing), notes
- API endpoint to create downtime log: `POST /api/equipment/[id]/downtime`
- Permission check: `EQUIPMENT_DOWNTIME_REPORT`

**Reason codes** (from schema):
```typescript
["mechanical_failure", "electrical_failure", "no_operator", "no_materials", "planned_maintenance", "changeover", "other"]
```

### 2. End Ongoing Downtime
**Status**: Not started
**What's needed**:
- If downtime has no `endTime`, show "End Downtime" button
- API endpoint: `PATCH /api/equipment/downtime/[id]` to set endTime

### 3. Quick Meter Reading Entry
**Status**: Partially done - links to edit form
**Current**: "Record Reading" button links to `/assets/equipment/[code]/edit#meters`
**Improvement idea**: Create a lightweight dialog for quick reading entry without navigating away

### 4. Commit Pending Changes
**Files modified (uncommitted)**:
- `src/lib/permissions.ts` - Added 3 new permissions
- `src/app/(app)/assets/equipment/[code]/edit/page.tsx` - Load meters/attachments
- `src/app/(app)/assets/equipment/[code]/page.tsx` - Premium sections on detail page

## File Reference

| File | Purpose |
|------|---------|
| `src/db/schema.ts` | Database schema with meters, downtime tables |
| `src/lib/permissions.ts` | Permission constants |
| `src/lib/utils/depreciation.ts` | Book value calculation |
| `src/lib/validations/equipment.ts` | Zod schemas |
| `src/app/(app)/assets/equipment/equipment-form.tsx` | Tabbed form |
| `src/app/(app)/assets/equipment/tabs/` | Tab components |
| `src/app/(app)/assets/equipment/[code]/page.tsx` | Detail page |
| `src/app/(app)/assets/equipment/[code]/edit/page.tsx` | Edit page |
| `src/app/(app)/api/equipment/[id]/meters/route.ts` | Meter list/create |
| `src/app/(app)/api/equipment/meters/[meterId]/route.ts` | Meter update/delete |

## Plan File
Original implementation plan: `/home/sdhui/.claude/plans/eventual-strolling-ritchie.md`

## Commands
```bash
bun run build:check  # Verify TypeScript
bun run dev          # Start dev server
bun run db:push      # Push schema changes
```

## Notes
- Financial data (purchasePrice, residualValue) stored as TEXT for decimal precision
- Attachments use S3/MinIO with `getPresignedDownloadUrl` from `@/lib/s3`
- Detail page uses `responsibleDepartment` relation (not `department`)
